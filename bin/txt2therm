#!/usr/bin/env ruby
VERSION = "dev"

require "optparse"
opts = {}
OptionParser.new do |options|
  options.banner = "usage: txt2therm [OPTIONS] [FILE]"
  options.separator "\nSend text to the thermal printer."
  options.separator "\nOptions:"

  options.on("-t", "--1x2", "Double height of text. (32 wide)") do |v|
    opts["t"] = true
    opts["1x2"] = true
  end

  options.on("-w", "--2x1", "Double width of text. (16 wide)") do |v|
    opts["w"] = true
    opts["2x1"] = true
  end

  options.on("-d", "--2x2", "Double width and height of text. (16 wide)") do |v|
    opts["d"] = true
    opts["2x2"] = true
  end

  options.on("-v", "--version", "Print version information and exit.") do
    puts "txt2therm #{VERSION}"
    exit
  end
end.parse!

trap("INT", "EXIT")

project_folder = File.dirname(File.dirname(File.realpath($0)))
require_relative "#{project_folder}/lib/thermal_printer.rb"

unless ThermalPrinter.activate
  puts "error activating printer"
  exit
end

input = if ARGV[0]
  File.read(ARGV[0]) if File.exist?(ARGV[0])
else
  STDIN.read
end

ThermalPrinter.write_text(input, opts["text_size"])
